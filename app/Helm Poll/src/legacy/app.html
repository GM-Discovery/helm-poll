<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Helm Poll</title>

  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-title" content="Helm Poll">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

  <link rel="manifest" href="/manifest.json">
  <link rel="apple-touch-icon" href="/icon-180.png">
  <link rel="icon" type="image/png" sizes="192x192" href="/icon-192.png">
  <link rel="icon" type="image/png" sizes="512x512" href="/icon-512.png">

  <!-- QR library (make sure this file exists in /opt/bread-poll-mvp/web/qrcode.min.js) -->
  <script src="/qrcode.min.js"></script>
</head>

<body>
  <div class="screen">
    <div class="wrap" id="app">

      <!-- Top header + global nav (always visible) -->
      <div class="topbar" style="align-items:flex-start;">
        <div style="flex:1;">
          <!-- Small brand/title -->
          <h1 style="margin:0; font-size:16px; font-weight:800; line-height:1.1;">Helm Poll</h1>
          <div class="muted" style="font-size:12px; margin-top:6px;">Create → Vote → Share → Live results.</div>

          <!-- Global tabs (always visible) -->
          <div class="pills" id="globalTabs" style="margin-top:12px;">
            <button id="tabCreate" class="pill active" type="button" data-tab="create" style="width:auto;">Create Poll</button>
            <button id="tabPolls" class="pill" type="button" data-tab="polls" style="width:auto;">Polls</button>
            <button id="tabSettings" class="pill" type="button" data-tab="settings" style="width:auto;">Settings</button>
          </div>
        </div>

        <!-- Share stays global (behavior unchanged; JS decides what it shares) -->
        <button id="shareBtn" class="btn-small btn-ghost" type="button" style="height:42px; width:auto;">Share</button>
      </div>

      <!-- ========================= -->
      <!-- PAGE: CREATE (Home)       -->
      <!-- ========================= -->
      <section id="viewCreate">
        <!-- Advanced settings hidden unless ?settings=1 -->
        <div class="card" id="apiCard" style="display:none;">
          <div class="row">
            <label class="muted" style="min-width:180px;">Advanced settings</label>
            <input id="apiBase" placeholder="Custom API endpoint (advanced use)" />
            <button id="saveApi" type="button">Save</button>
            <span id="apiStatus" class="muted"></span>
          </div>
        </div>

        <!-- Create -->
        <div class="card" id="createCard">
          <h2 style="margin-bottom:6px;">Create</h2>
          <div class="muted2" style="font-size:12px; margin-bottom:12px;">Make a poll, then share the link or QR.</div>

          <div class="grid">
            <input id="newTitle" placeholder="Poll title" />

            <label style="display:block; margin-top:12px; font-weight:600;">Question / Details</label>
            <div id="questionEditor" style="margin-top:8px;"></div>

            <div class="row">
              <label class="muted" style="min-width:52px;">Type</label>
              <select id="newType" style="max-width:260px;">
                <option value="YES_NO">YES or NO</option>
                <option value="SINGLE_SELECT">LIST SELECT</option>
              </select>
            </div>

            <textarea id="newOptions" rows="3" placeholder="Options (one per line). Leave blank for YES_NO."></textarea>

            <button id="createPoll" type="button">SAVE</button>

            <!-- Success / status output (existing) -->
            <div id="createOut" class="muted"></div>

            <!-- Optional: “Go to Polls” button after create (JS decides when to show) -->
            <button id="goToPolls" type="button" class="btn-ghost" style="display:none;">Go to Polls</button>
          </div>
        </div>
      </section>

      <!-- ========================= -->
      <!-- PAGE: POLLS               -->
      <!-- ========================= -->
      <section id="viewPolls" style="display:none;">

        <!-- Poll List View -->
        <div class="card" id="pollsListCard">
          <div class="topbar">
            <div>
              <h2 style="margin:0;">Polls</h2>
              <div class="muted2" style="font-size:12px; margin-top:6px;">Newest first.</div>
            </div>
            <button id="refreshPolls" type="button" class="btn-small btn-ghost" style="width:auto; height:42px;">Refresh</button>
          </div>

          <div style="margin-top:12px;">
            <input id="search" placeholder="Search polls…" />
          </div>

          <div id="emptyState" class="muted" style="display:none; padding:14px; text-align:center;">
            No polls yet. Create one in Create Poll.
          </div>

          <!-- Make the list scrollable without theme work -->
          <div style="margin-top:12px; max-height:60vh; overflow:auto;">
            <div id="pollList" class="grid"></div>
          </div>
        </div>

        <!-- Poll Detail View (Single Poll) -->
        <div class="card" id="pollView" style="display:none;">
          <div class="row" style="justify-content:space-between; width:100%;">
            <div style="display:flex; flex-direction:column; gap:6px; min-width: 60%;">
              <h2 id="pollTitle" style="margin:0;"></h2>

              <!-- Prominent status line (JS populates #pollMeta today; keep ID, but give it room) -->
              <div class="muted" id="pollMeta" style="margin-top:6px; font-size:14px;"></div>
            </div>

            <div class="row" style="justify-content:flex-end;">
              <!-- Back control required -->
              <button id="backToList" type="button" class="btn-small btn-ghost" style="width:auto; height:42px;">Back to list</button>
              <!-- Existing close button retained -->
              <button id="closePoll" type="button" class="btn-small btn-ghost" style="width:auto; height:42px;">Close</button>
            </div>
          </div>

          <!-- Description (if present). JS can fill this, or ignore if it already uses pollMeta. -->
          <div id="pollDescription" class="muted2" style="margin-top:12px; display:none;"></div>

          <hr />

          <h3 style="margin-top:8px;">Vote</h3>
          <div id="voteButtons" class="row"></div>
          <div class="muted" id="voteOut"></div>

          <h3 style="margin-top:16px;">Results</h3>

          <!-- Human-readable results (weighted-first) -->
          <div id="resultsPretty">

            <!-- Headline card -->
            <div class="resultsHeadline">
              <div class="resultsHeadlineTop">
                <div class="resultsHeadlineTitle">Results</div>
                <div id="resultsLocalWarn" class="resultsLocalWarn" style="display:none;">
                  VOTE NOT YET ON THE EXCHANGE - Assert Button Below
                </div>
                <div id="resultsValidated" class="resultsValidated"></div>
              </div>

              <div class="resultsBigRow">
                <div class="resultsBigLabel">Represented weight</div>
                <div id="resultsRepresented" class="resultsBigValue">—</div>
              </div>

              <div class="resultsStatsRow">
                <div class="resultsStat">
                  <div class="resultsStatLabel">People voted</div>
                  <div id="resultsPeople" class="resultsStatValue">—</div>
                </div>

                <div class="resultsStat">
                  <div class="resultsStatLabel">Ballots stored</div>
                  <div id="resultsBallots" class="resultsStatValue">—</div>
                </div>
              </div>

              <div id="resultsDebug" class="muted" style="margin-top:8px;"></div>
            </div>

            <!-- Option rows -->
            <div id="resultsRows" class="resultsRows"></div>

            <!-- Audit / JSON (collapsed by default) -->
            <details class="resultsAudit">
              <summary>Details / Audit JSON</summary>
              <pre id="resultsBox">{}</pre>
            </details>

          </div>


          <div class="muted" style="margin-top:12px;">
            Link: <a id="shareLink" href="#" target="_blank" rel="noreferrer"></a>
            <button id="copyLink" type="button" class="smallBtn" style="margin-left:10px;">Copy</button>
          </div>

          <hr />

          <!-- Assert moved into Poll Detail (required) -->
          <button id="assertBtn" type="button">Assert to Exchange</button>
          <div id="assertStatus" class="muted" style="margin-top:8px;"></div>
            Votes are not counted unless asserted to an "Exchange."
          </div>
          <div id="assertOut"></div>
        </div>

      </section>

      <!-- ========================= -->
      <!-- PAGE: SETTINGS / IDENTITY -->
      <!-- ========================= -->
      <section id="viewSettings" style="display:none;">
        <div class="card" id="settingsCard">
          <h2 style="margin-bottom:6px;">Settings / Identity</h2>
          <div class="muted2" style="font-size:12px; margin-bottom:12px;">
            Minimal in Phase 1. Intended to split later.
          </div>

          <h3 style="margin-top:6px;">Identity</h3>
          <div class="muted2" style="font-size:12px; margin-bottom:10px;">
            Stored locally on this device. Your signing key is shown only once on creation.
          </div>

          <div class="grid">
            <div class="row">
              <label class="muted" style="min-width:140px;">Display name</label>
              <input id="identityDisplayName" placeholder="Optional: name shown in the UI (local only)" />
            </div>

            <div class="row">
              <label class="muted" style="min-width:140px;">Password</label>
              <input id="identitySigningKey" placeholder="Created once; keep it safe. Used to sign requests." type="password" />
            </div>

            <div class="row" style="gap:10px; flex-wrap:wrap;">
              <button id="createIdentityBtn" type="button">Create Identity</button>
              <button id="copyIdentityBackupBtn" type="button" class="btn-ghost">Copy Recovery Code</button>
            </div>

            <div id="identityStatus" class="muted"></div>
          </div>

          <hr />

          <div id="exchangeStatus" class="muted" style="margin-top:10px;"></div>
          
          <div class="row" style="gap:10px; flex-wrap:wrap; margin-top:10px;">
            <div class="card" style="padding:10px; min-width:160px;">
              <div class="muted2" style="font-size:12px;">TRUST POINTS</div>
              <div id="statTrustPoints" style="font-size:18px; font-weight:600;">1</div>
            </div>
            <div class="card" style="padding:10px; min-width:160px;">
              <div class="muted2" style="font-size:12px;">Earned Trust</div>
              <div id="statEarnedTrust" style="font-size:18px; font-weight:600;">—</div>
            </div>
            <div class="card" style="padding:10px; min-width:160px;">
              <div class="muted2" style="font-size:12px;">Delegated Trust</div>
              <div id="statDelegatedTrust" style="font-size:18px; font-weight:600;">—</div>
            </div>
          </div>
          

          <h3 style="margin-top:6px;">Stamps</h3>
          <div class="muted2" style="font-size:12px; margin-bottom:10px;">
            Stamps are ephemeral. The app hides stamp tokens and mints only when needed.
          </div>

          <div class="row" style="gap:10px; flex-wrap:wrap;">
            <button id="mintStampBtn" type="button" class="btn-ghost">Mint Stamp</button>
            <button id="clearStampsBtn" type="button" class="btn-ghost">Clear Stamps</button>
            <span id="stampStatus" class="muted"></span>
          </div>

          <hr />

          <h3 style="margin-top:6px;">Delegation</h3>
          <div class="muted2" style="font-size:12px; margin-bottom:10px;">
            Delegate some of your trust to another public alias (outbound delegation).
          </div>

          <div class="grid">
            <div class="row">
              <label class="muted" style="min-width:140px;">Delegatee alias</label>
              <input id="delegateeAliasInput" placeholder="a_..." />
            </div>

            <div class="row">
              <label class="muted" style="min-width:140px;">Amount</label>
              <input id="delegateAmountInput" placeholder="1" inputmode="numeric" />
            </div>

            <div class="row" style="gap:10px; flex-wrap:wrap;">
              <button id="delegationSetBtn" type="button">Set / Update Delegation</button>
              <button id="delegationRevokeBtn" type="button" class="btn-ghost">Revoke Delegation</button>
            </div>

            <div id="delegationStatus" class="muted"></div>
          </div>

          <hr />
          <hr />

          <h3>Admin</h3>
          <div class="muted2" style="font-size:12px; margin-bottom:10px;">
            Operator key is stored for this browser session only.
          </div>

          <div class="row" style="gap:10px; flex-wrap:wrap;">
            <input id="operatorKeyInput" placeholder="Operator key (session only)" type="password" style="flex:1; min-width:220px;" />
            <button id="enterAdminBtn" type="button" class="btn-ghost">Enter Admin Panel</button>
          </div>

          <div id="adminStatus" class="muted" style="margin-top:10px;">Admin mode inactive.</div>
        </div>
      </section>

      <!-- QR Share Modal (unchanged) -->
      <div id="qrModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.45); padding:24px; z-index:9999;">
        <div style="max-width:420px; margin:10vh auto; background:#fff; border-radius:16px; padding:18px; box-shadow:0 10px 30px rgba(0,0,0,0.18);">
          <div class="row" style="justify-content:space-between; align-items:center;">
            <strong>Share</strong>
            <button id="qrClose" type="button" class="smallBtn" style="padding:8px 12px;">Close</button>
          </div>

          <p class="muted" style="margin-top:10px;">Scan this QR code to open the poll.</p>

          <div id="qrBox" style="display:flex; justify-content:center; padding:14px;"></div>

          <div style="margin-top:10px;">
            <div class="muted" style="font-size:12px; word-break:break-all;" id="qrLinkText"></div>
            <div class="row" style="margin-top:10px;">
              <button id="copyLinkQr" type="button">Copy Link</button>
            </div>
            <div class="muted" id="copyStatus" style="margin-top:6px; font-size:12px;"></div>
          </div>
        </div>
      </div>

    </div>
  </div>

  <script type="module" src="/src/main.js"></script>
</body>
</html>
